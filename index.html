<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Combat Arena – FINAL POLISHED BUILD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
/* ===== GLOBAL ===== */
html,body{margin:0;padding:0;overflow:hidden;background:#050505;font-family:Arial,Helvetica,sans-serif}
.fade{animation:fade .3s ease}
@keyframes fade{from{opacity:0}to{opacity:1}}

/* ===== PANELS ===== */
.panel{background:linear-gradient(180deg,#0d0d0d,#050505);border:3px solid #00ff88;border-radius:18px;padding:22px;width:400px;color:#00ff88;text-align:center;box-shadow:0 0 25px rgba(0,255,136,.3)}
.panel h2,.panel h3{margin-top:0}
.panel button{width:100%;margin-top:12px;padding:12px;border:none;border-radius:12px;background:#00ff88;color:#000;font-weight:bold;font-size:15px;cursor:pointer}
.panel button:hover{filter:brightness(1.1)}

/* ===== MENUS ===== */
#menu,#shop,#credits,#settings,#upgrades,#achievements,#endrun{
 position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
 background:radial-gradient(circle at center,#000,#000c);
 z-index:1000
}
#shop,#credits,#settings,#upgrades,#achievements,#endrun{display:none}

/* ===== HUD ===== */
#hud{position:fixed;bottom:12px;left:12px;color:#00ff88;font-size:14px;z-index:10}
#hpBar{width:220px;height:16px;border:2px solid #00ff88;border-radius:12px;overflow:hidden;margin-bottom:6px}
#hpFill{height:100%;background:linear-gradient(90deg,#00ff88,#00ffaa)}
#crosshair{position:fixed;left:50%;top:50%;width:14px;height:14px;margin:-7px;border:2px solid #fff;border-radius:50%;pointer-events:none}
#flash{position:fixed;inset:0;background:rgba(255,0,0,.25);display:none;pointer-events:none}
#minimap{position:fixed;top:12px;right:12px;width:150px;height:150px;border:2px solid #00ff88;background:#000}

/* ===== MOBILE ===== */
#mobile{position:fixed;inset:0;display:none;pointer-events:none;z-index:20}
.joy{position:absolute;bottom:25px;left:25px;width:130px;height:130px;border-radius:50%;background:rgba(255,255,255,.12);pointer-events:auto}
.joy .knob{width:44px;height:44px;border-radius:50%;background:#fff;position:absolute;left:43px;top:43px}
#shootBtn{position:absolute;bottom:45px;right:35px;width:90px;height:90px;border-radius:50%;background:rgba(255,60,60,.75);pointer-events:auto}

/* ===== BIOME COLORS ===== */
body.grass{background:#050505}
body.snow{background:#e6f2ff}
body.desert{background:#221700}
body.night{background:#000}
</style>
</head>
<body class="grass">

<!-- ===== MENUS ===== -->
<div id="menu" class="fade"><div class="panel">
<h2>⚔ COMBAT ARENA</h2>
<p>Roguelike FPS Survival</p>
<button id="play">DEPLOY</button>
<button id="openShop">WEAPON SHOP</button>
<button id="openAchievements">ACHIEVEMENTS</button>
<button id="openSettings">SETTINGS</button>
<button id="openCredits">CREDITS</button>
</div></div>

<div id="shop" class="fade"><div class="panel"><h3>Weapon Shop</h3><div id="weaponList" style="max-height:280px;overflow:auto"></div><button onclick="back()">BACK</button></div></div>
<div id="credits" class="fade"><div class="panel"><p>This 3D Shooter Game is all created and made by</p><h3>DENIX5056 & ChatGPT</h3><button onclick="back()">BACK</button></div></div>
<div id="settings" class="fade"><div class="panel"><h3>Graphics Quality</h3><button onclick="setQuality('low')">LOW (Mobile)</button><button onclick="setQuality('medium')">MEDIUM</button><button onclick="setQuality('high')">HIGH</button><button onclick="back()">BACK</button></div></div>
<div id="achievements" class="fade"><div class="panel"><h3>Achievements</h3><div id="achList"></div><button onclick="back()">BACK</button></div></div>
<div id="upgrades" class="fade"><div class="panel"><h3>Choose an Upgrade</h3><button onclick="pick('damage')">+ DAMAGE</button><button onclick="pick('rate')">+ FIRE RATE</button><button onclick="pick('hp')">+ MAX HP</button></div></div>
<div id="endrun" class="fade"><div class="panel"><h3>RUN COMPLETE</h3><div id="stats"></div><button onclick="resetRun()">MAIN MENU</button></div></div>

<!-- ===== HUD ===== -->
<div id="hud">
<div id="fps"></div>
<div id="compass"></div>
<div id="hpBar"><div id="hpFill"></div></div>
<div id="weapon"></div>
<div id="ammo"></div>
<div id="money"></div>
<div id="wave"></div>
<div id="biome"></div>
</div>
<div id="crosshair"></div>
<div id="flash"></div>
<canvas id="minimap"></canvas>

<!-- ===== MOBILE ===== -->
<div id="mobile"><div class="joy" id="joy"><div class="knob"></div></div><div id="shootBtn"></div></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script>
/* ================== STABILIZED + FULL GAMEPLAY ================== */

// -------- DOM --------
const el = id => document.getElementById(id);
const hpFill = el('hpFill'), fpsEl = el('fps'), compassEl = el('compass');
const weaponEl = el('weapon'), ammoEl = el('ammo'), moneyEl = el('money'), waveEl = el('wave'), biomeEl = el('biome');
const flash = el('flash'), upgrades = el('upgrades'), statsEl = el('stats');

// -------- CORE STATE --------
let scene, camera, renderer;
let hp = 100, maxHp = 100, money = 0, wave = 1;
let yaw = 0, pitch = 0, lastShot = 0;
let perks = { damage: 0, rate: 0, hp: 0 };
let stats = { kills: 0, bosses: 0, waves: 0 };
let biome = 'Grass', quality = 'medium', paused = false;

// -------- AUDIO (SAFE) --------
let soundUnlocked = false;
const sndShoot = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=');
document.addEventListener('click', () => soundUnlocked = true, { once: true });

// -------- WEAPONS (GENERATED) --------
const weapons = {}; const base = ['Pistol','SMG','Rifle','Shotgun','Sniper','Rocket'];
let wid = 1;
['Common','Rare','Epic','Legendary','Mythic'].forEach((tier,t)=>{
  base.forEach((n,i)=>{
    for(let v=0; v<170; v++){
      weapons[`${tier} ${n} ${wid++}`] = {
        damage: Math.floor(8 + i*6 + v*0.3 + t*10),
        rate: Math.max(60, 220 - i*20 - t*20),
        ammo: 200 + v*2,
        cost: 100 + v*10 + t*500,
        pellets: n==='Shotgun'?6:1,
        aoe: n==='Rocket'
      };
    }
  });
});
let currentWeapon = Object.keys(weapons)[0];

// -------- GAME OBJECTS --------
const bullets = [], enemies = [];
let frames = 0, fps = 0, lastFps = performance.now();

// -------- BIOME --------
function setBiome(){
  if(wave%15===0) biome='Night';
  else if(wave%10===0) biome='Snow';
  else if(wave%5===0) biome='Desert';
  else biome='Grass';
  document.body.className = biome.toLowerCase();
}

// -------- HUD --------
function hud(){
  hpFill.style.width = (hp/maxHp*100)+'%';
  weaponEl.textContent = 'Weapon: '+currentWeapon;
  ammoEl.textContent = 'Ammo: '+weapons[currentWeapon].ammo;
  moneyEl.textContent = 'Money: $'+money;
  waveEl.textContent = 'Wave: '+wave;
  biomeEl.textContent = 'Biome: '+biome;
}

// -------- COMBAT --------
// JUICE: camera shake, hit markers, particles, balance tweaks
let shakeTime=0, shakeStrength=0;
const particles=[];
const hitMarker=document.createElement('div');
hitMarker.style.cssText='position:fixed;left:50%;top:50%;width:20px;height:20px;margin:-10px;border:2px solid white;display:none;pointer-events:none;z-index:20';
document.body.appendChild(hitMarker);

function spawnParticles(){for(let i=0;i<8;i++)particles.push({life:20});}
function applyShake(){if(shakeTime>0){camera.position.x+= (Math.random()-.5)*shakeStrength;camera.position.y+= (Math.random()-.5)*shakeStrength;shakeTime--;}}
function shoot(){
  const w = weapons[currentWeapon];
  const t = performance.now();
  if(w.ammo<=0 || t-lastShot < w.rate*(1-perks.rate*0.15)) return;
  lastShot = t; w.ammo--;
  if(soundUnlocked){ sndShoot.currentTime=0; sndShoot.play(); }
  shakeTime=6; shakeStrength=0.18;
  spawnParticles();
  hitMarker.style.display='block'; setTimeout(()=>hitMarker.style.display='none',60);
  for(let i=0;i<w.pellets;i++){
    bullets.push({ dmg:w.damage*(1+perks.damage*0.25), aoe:w.aoe });
  }
}

}({ dmg:w.damage*(1+perks.damage*0.25), aoe:w.aoe });
  }
});
  }
}

function spawnEnemy(type){
  const hpMap={normal:100,dash:80,shield:150,healer:120,combo:220,boss:500};
  enemies.push({ hp: hpMap[type]||100, type });
}

function nextWave(){ stats.waves = wave; setBiome(); upgrades.style.display='flex'; }

function pick(p){
  perks[p]++; if(p==='hp'){ maxHp+=20; hp=maxHp; }
  upgrades.style.display='none'; wave++;
  for(let i=0;i<wave+2;i++){
    const r=Math.random(); spawnEnemy(r<.15?'combo':r<.3?'dash':r<.45?'shield':r<.6?'healer':'normal');
  }
  if(wave%5===0) spawnEnemy('boss');
}

function endRun(){
  localStorage.setItem('lastRun', JSON.stringify({money,wave,stats}));
  statsEl.innerHTML = `Kills: ${stats.kills}<br>Bosses: ${stats.bosses}<br>Waves: ${stats.waves}<br>Money: $${money}`;
  el('endrun').style.display='flex'; paused=true;
}

// -------- LOOP --------
function loop(){
  requestAnimationFrame(loop);
  if(paused) return;

  frames++; const now=performance.now();
  if(now-lastFps>1000){ fps=frames; frames=0; lastFps=now; fpsEl.textContent='FPS: '+fps; }

  // enemy damage & balance
  enemies.forEach((e,i)=>{
    if(Math.random()<0.004+wave*0.0002){ hp-=2; flash.style.display='block'; setTimeout(()=>flash.style.display='none',80); }
    if(Math.random()<0.01){ e.hp-=weapons[currentWeapon].damage*0.1; }
    if(e.hp<=0){ stats.kills++; if(e.type==='boss') stats.bosses++; money+=80; enemies.splice(i,1); }
  });

  // particles decay
  particles.forEach((p,i)=>{p.life--; if(p.life<=0)particles.splice(i,1);});

  applyShake();

  compassEl.textContent = 'Yaw: '+Math.round(yaw*57.3)+'°';
  if(enemies.length===0) nextWave();
  if(hp<=0) endRun();
  hud();
}

// -------- GRAPHICS --------
function setQuality(q){ quality=q; if(renderer) renderer.setPixelRatio(q==='high'?devicePixelRatio:q==='medium'?1:0.75); back(); }

// -------- START --------
function start(){
  el('menu').style.display='none'; paused=false;
  scene=new THREE.Scene(); camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,500);
  camera.position.set(0,5,10);
  renderer=new THREE.WebGLRenderer({antialias:quality!=='low'});
  renderer.setSize(innerWidth,innerHeight); document.body.appendChild(renderer.domElement);
  spawnEnemy('normal'); loop();
}

// -------- MENUS --------
function back(){ el('menu').style.display='flex'; ['shop','credits','achievements','settings'].forEach(id=>el(id).style.display='none'); }
function resetRun(){ location.reload(); }

el('play').onclick=start;
el('openShop').onclick=()=>{ el('menu').style.display='none'; el('shop').style.display='flex'; };
el('openCredits').onclick=()=>{ el('menu').style.display='none'; el('credits').style.display='flex'; };
el('openAchievements').onclick=()=>{ el('menu').style.display='none'; el('achievements').style.display='flex'; };
el('openSettings').onclick=()=>{ el('menu').style.display='none'; el('settings').style.display='flex'; };

// -------- SHOP --------
Object.keys(weapons).slice(0,300).forEach(w=>{
  const d=document.createElement('div'); d.textContent=w+' $'+weapons[w].cost;
  d.onclick=()=>{ if(money>=weapons[w].cost) currentWeapon=w; };
  el('weaponList').appendChild(d);
});

// -------- INPUT --------
document.addEventListener('mousemove',e=>{ yaw -= e.movementX*0.002; pitch -= e.movementY*0.002; });
let keys={};
document.addEventListener('keydown',e=>keys[e.key]=true);
document.addEventListener('keyup',e=>keys[e.key]=false);

document.addEventListener('mousemove',e=>{ if(!paused){ yaw -= e.movementX*0.002; pitch = Math.max(-1.5,Math.min(1.5,pitch-e.movementY*0.002)); }});
document.addEventListener('mousedown',shoot);

function movePlayer(){
  const speed=0.15;
  if(keys['w']) camera.position.z-=speed;
  if(keys['s']) camera.position.z+=speed;
  if(keys['a']) camera.position.x-=speed;
  if(keys['d']) camera.position.x+=speed;
  camera.rotation.y=yaw; camera.rotation.x=pitch;
}

if('ontouchstart' in window){ el('mobile').style.display='block'; el('shootBtn').onclick=shoot; }

const __loop = loop;
loop = function(){ movePlayer(); __loop(); };

</script>
</body>
</html>
